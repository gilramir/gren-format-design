module CodeView exposing (view)

import Basics
import Math

import Html exposing (Html)
import Html.Attributes exposing (attribute)
import Svg exposing (..)
import Svg.Attributes exposing (..)

{- Draw monospaced text, with vertical guidelines at specified
column positions, and with alternating very-slightly higlighted rows
(zebra strips) of text.

Thank you, Gemini LLM.

Key Technical Details:

xml:space="preserve": This is a critical SVG attribute. Without it,
the browser will collapse multiple spaces into a single space, breaking
your monospaced alignment.

Coordinate Math: The text is shifted down by paddingTop to make room
for the column labels (80, 100, etc.).

Dynamic Sizing: The function calculates the necessary viewBox width by
checking both the longest line of code and the highest column marker.

Visual Style: I used strokeDasharray for the lines. In scholarly
or technical drafting, dashed lines represent "guides" rather than
"boundaries," which feels more appropriate for code column limits.
-}

type alias Model =
    { code : String
    , guides : Array Int
    }

-- CONFIGURATION CONSTANTS
charWidth : Float
charWidth = 9.6

lineHeight : Float
lineHeight = 20.0

paddingTop : Float
paddingTop = 40.0 -- Extra space for the column numbers

fontSizePx : Int
fontSizePx = 16

{-| Renders the code with vertical column guides.
-}
view : String -> Array Int -> String -> Html msg
view codeContent guideColumns figureCaption =
    let
        -- 1. Setup dimensions
        lines = String.split "\n" codeContent
        numLines = Array.length lines
        
        internalMargin = 20.0
        captionSpace = 40.0
        
        -- The frame should only contain the guides and the code
        frameHeight = (toFloat numLines * lineHeight) + paddingTop + (internalMargin * 2)
        
        -- The total SVG height includes the caption area below the frame
        totalHeight = frameHeight + captionSpace
        
        -- Width calculation remains the same
        maxCodeChars = Array.foldl (\line acc -> Basics.max (String.count line) acc) 0 lines
        maxGuideCol = Array.foldl Basics.max 0 guideColumns
        totalWidth = (Basics.max (toFloat maxCodeChars) (toFloat maxGuideCol) * charWidth) + (internalMargin * 2)
    in
    svg
        [ width (String.fromFloat totalWidth)
        , height (String.fromFloat totalHeight)
        , viewBox ("0 0 " ++ String.fromFloat totalWidth ++ " " ++ String.fromFloat totalHeight)
        ]
        [ -- 1. The Frame
          rect
            [ x "0"
            , y "0"
            , width (String.fromFloat totalWidth)
            , height (String.fromFloat frameHeight) -- Fixed to frameHeight
            , fill "#ffffff"
            , stroke "#dcdcdc"
            , strokeWidth "1"
            , rx "2"
            ]
            []

        -- 2. Zebra Stripes
        , g [ transform ("translate(0, " ++ String.fromFloat (paddingTop + internalMargin) ++ ")") ]
            (Array.indexedMap renderStripe lines)
            
        -- 3. The Guides (Now passing frameHeight to truncate the lines)
        , g [ transform ("translate(" ++ String.fromFloat internalMargin ++ ", 0)") ]
            (Array.map (renderGuide frameHeight) guideColumns)

        -- 4. The Code Text (Shifted by margin and paddingTop)
        , g [ transform ("translate(" ++ String.fromFloat internalMargin ++ ", " ++ String.fromFloat (paddingTop + internalMargin) ++ ")") ]
            (Array.indexedMap renderLine lines)
            
        -- 5. The Figure Caption
        , text_
            [ x (String.fromFloat (totalWidth / 2))
            , y (String.fromFloat (totalHeight - 15))
            , textAnchor "middle"
            , fontFamily "var(--font-serif)" -- Using your scholarly serif font
            , fontSize "14"
            , fontStyle "italic"
            , fill "#555"
            ]
            [ text figureCaption ]        
        ]

-- Updated renderGuide to accept the height limit
renderGuide : Float -> Int -> Svg msg
renderGuide limitHeight col =
    let
        xPos = String.fromFloat (toFloat col * charWidth)
    in
    g []
        [ line
            [ x1 xPos
            , y1 "30" -- Start just below the column number
            , x2 xPos
            , y2 (String.fromFloat limitHeight) -- STOP exactly at the frame edge
            , stroke "#d1d1d1"
            , strokeWidth "1"
            , strokeDasharray "4,4"
            ]
            []
        , text_ [ x xPos, y "20", textAnchor "middle", fill "#888", fontSize "12" ]
            [ text (String.fromInt col) ]
        ]

renderLine : Int -> String -> Svg msg
renderLine index lineText =
    text_
        [ x "0"
        , y (String.fromFloat (toFloat index * lineHeight + 15))
        , fontFamily "monospace"
        , fontSize (String.fromInt fontSizePx)
        , fill "#222"
        -- This ensures the browser preserves spaces
        , attribute "xml:space" "preserve" 
        ]
        [ text lineText ]



{-| Renders a subtle background rectangle for even-numbered lines.
-}
renderStripe : Int -> String -> Svg msg
renderStripe index _ =
    if Math.modBy 2 index == 1 then
        rect
            [ x "1" -- Offset slightly to not overlap the frame's left border
            , y (String.fromFloat (toFloat index * lineHeight))
            , width "99%" -- Fills the width of the frame
            , height (String.fromFloat lineHeight)
            , fill "#f9f9f7" -- A very subtle paper-gray
            ]
            []
    else
        text "" -- Don't draw anything for odd lines
